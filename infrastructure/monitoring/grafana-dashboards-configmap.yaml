# Grafana - Provisioning des dashboards (tout en code)
# =====================================================
# Overview + Loki + Node Summary + Par nœud (Raspberry). Pour Node Exporter Full (1860)
# : Dashboard → Import → id 1860 (optionnel, très détaillé).
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: monitoring
  labels:
    app: grafana
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: default
        orgId: 1
        folder: KubeSecureBox
        type: file
        disableDeletion: false
        editable: false
        options:
          path: /etc/grafana/provisioning/dashboards
  overview.json: |
    {
      "id": null,
      "uid": "kubesecurebox-overview",
      "title": "KubeSecureBox Overview",
      "tags": ["kubesecurebox"],
      "schemaVersion": 38,
      "version": 1,
      "panels": [
        {
          "id": 1,
          "type": "stat",
          "title": "Prometheus",
          "gridPos": { "h": 4, "w": 4, "x": 0, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": { "graphMode": "none", "colorMode": "value" },
          "targets": [{ "expr": "up{job=\"prometheus\"}", "refId": "A" }]
        },
        {
          "id": 2,
          "type": "stat",
          "title": "Nodes",
          "gridPos": { "h": 4, "w": 4, "x": 4, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": { "graphMode": "none", "colorMode": "value" },
          "targets": [{ "expr": "count(kube_node_info)", "refId": "A" }]
        },
        {
          "id": 3,
          "type": "stat",
          "title": "Pods total",
          "gridPos": { "h": 4, "w": 4, "x": 8, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": { "graphMode": "none", "colorMode": "value" },
          "targets": [{ "expr": "count(kube_pod_info)", "refId": "A" }]
        },
        {
          "id": 4,
          "type": "stat",
          "title": "Pods Not Ready (readiness)",
          "description": "Pods en Running mais pas prêts (readiness probe)",
          "gridPos": { "h": 4, "w": 4, "x": 12, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": { "graphMode": "none", "colorMode": "value" },
          "targets": [{ "expr": "count(kube_pod_status_ready == 0)", "refId": "A" }]
        },
        {
          "id": 5,
          "type": "stat",
          "title": "Mémoire dispo %",
          "gridPos": { "h": 4, "w": 4, "x": 16, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": { "graphMode": "none", "colorMode": "value" },
          "fieldConfig": { "defaults": { "unit": "percentunit", "min": 0, "max": 1 } },
          "targets": [{ "expr": "sum(node_memory_MemAvailable_bytes)/sum(node_memory_MemTotal_bytes)", "refId": "A" }]
        },
        {
          "id": 6,
          "type": "stat",
          "title": "CPU usage %",
          "gridPos": { "h": 4, "w": 4, "x": 20, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": { "graphMode": "none", "colorMode": "value" },
          "fieldConfig": { "defaults": { "unit": "percentunit", "min": 0, "max": 1 } },
          "targets": [{ "expr": "1 - avg(rate(node_cpu_seconds_total{mode=\"idle\"}[5m]))", "refId": "A" }]
        },
        {
          "id": 7,
          "type": "stat",
          "title": "Disque utilisé %",
          "description": "Espace disque utilisé (cluster, ext4/xfs, node_exporter)",
          "gridPos": { "h": 4, "w": 4, "x": 0, "y": 4 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": { "graphMode": "none", "colorMode": "value" },
          "fieldConfig": { "defaults": { "unit": "percentunit", "min": 0, "max": 1 } },
          "targets": [{ "expr": "1 - sum(node_filesystem_avail_bytes{fstype=~\"ext4|xfs\"})/sum(node_filesystem_size_bytes{fstype=~\"ext4|xfs\"})", "refId": "A" }]
        },
        {
          "id": 8,
          "type": "text",
          "title": "Logs (Loki)",
          "gridPos": { "h": 4, "w": 4, "x": 4, "y": 4 },
          "options": { "content": "**Logs**\n\n[Ouvrir Explore Loki](/explore?orgId=1&left={\"datasource\":\"loki\"})", "mode": "markdown" },
          "links": [{ "title": "Explore Loki", "url": "/explore?orgId=1&left={\"datasource\":\"loki\"}" }]
        }
      ],
      "refresh": "30s"
    }
  loki-logs.json: |
    {"annotations":{"list":[]},"editable":true,"gnetId":12019,"graphTooltip":0,"id":null,"links":[],"panels":[{"datasource":{"type":"loki","uid":"loki"},"gridPos":{"h":25,"w":24,"x":0,"y":0},"id":2,"options":{"showLabels":false,"showTime":true,"sortOrder":"Descending","wrapLogMessage":true},"targets":[{"expr":"{namespace=~\"$namespace\"} |~ \"$search\"","refId":"A"}],"title":"Logs Panel","type":"logs"}],"schemaVersion":38,"tags":["loki","logs"],"templating":{"list":[{"current":{},"datasource":{"type":"prometheus","uid":"prometheus"},"definition":"label_values(kube_pod_info, namespace)","hide":0,"includeAll":false,"name":"namespace","options":[],"query":"label_values(kube_pod_info, namespace)","refresh":1,"sort":0,"type":"query"},{"current":{},"hide":0,"name":"search","options":[{"selected":true,"text":"","value":""}],"query":"","type":"textbox"}]},"time":{"from":"now-6h","to":"now"},"title":"Loki - Logs","uid":"loki-logs-kubesecurebox","version":1}
  node-summary.json: |
    {"id":null,"uid":"node-summary-kubesecurebox","title":"Node Summary","tags":["node-exporter","kubesecurebox"],"schemaVersion":38,"version":1,"refresh":"30s","panels":[{"id":1,"type":"stat","title":"CPU usage % (cluster)","gridPos":{"h":4,"w":6,"x":0,"y":0},"datasource":{"type":"prometheus","uid":"prometheus"},"options":{"graphMode":"none","colorMode":"value"},"fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1}},"targets":[{"expr":"1 - avg(rate(node_cpu_seconds_total{mode=\"idle\"}[5m]))","refId":"A"}]},{"id":2,"type":"stat","title":"Mémoire dispo % (cluster)","gridPos":{"h":4,"w":6,"x":6,"y":0},"datasource":{"type":"prometheus","uid":"prometheus"},"options":{"graphMode":"none","colorMode":"value"},"fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1}},"targets":[{"expr":"sum(node_memory_MemAvailable_bytes)/sum(node_memory_MemTotal_bytes)","refId":"A"}]},{"id":3,"type":"stat","title":"Nodes (node_exporter)","gridPos":{"h":4,"w":6,"x":12,"y":0},"datasource":{"type":"prometheus","uid":"prometheus"},"options":{"graphMode":"none","colorMode":"value"},"targets":[{"expr":"count(count by (instance)(node_cpu_seconds_total))","refId":"A"}]},{"id":4,"type":"stat","title":"Disque utilisé % (cluster)","gridPos":{"h":4,"w":6,"x":18,"y":0},"datasource":{"type":"prometheus","uid":"prometheus"},"options":{"graphMode":"none","colorMode":"value"},"fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1}},"targets":[{"expr":"1 - sum(node_filesystem_avail_bytes{fstype=~\"ext4|xfs\"})/sum(node_filesystem_size_bytes{fstype=~\"ext4|xfs\"})","refId":"A"}]}]}
  nodes-raspberry.json: |
    {"id":null,"uid":"nodes-raspberry-kubesecurebox","title":"Par nœud (Raspberry)","tags":["node-exporter","kubesecurebox","raspberry"],"schemaVersion":38,"version":1,"refresh":"30s","templating":{"list":[{"name":"instance","datasource":{"type":"prometheus","uid":"prometheus"},"query":"label_values(node_cpu_seconds_total, instance)","current":{"value":"$__all","text":"All"},"includeAll":true,"multi":true,"refresh":1,"type":"query","hide":0}]},"panels":[{"id":1,"type":"stat","title":"CPU usage %","gridPos":{"h":4,"w":3,"x":0,"y":0},"datasource":{"type":"prometheus","uid":"prometheus"},"options":{"graphMode":"none","colorMode":"value"},"fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1}},"targets":[{"expr":"1 - avg(rate(node_cpu_seconds_total{mode=\"idle\", instance=~\"$instance\"}[5m]))","refId":"A"}]},{"id":2,"type":"stat","title":"Mémoire dispo %","gridPos":{"h":4,"w":3,"x":3,"y":0},"datasource":{"type":"prometheus","uid":"prometheus"},"options":{"graphMode":"none","colorMode":"value"},"fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1}},"targets":[{"expr":"sum(node_memory_MemAvailable_bytes{instance=~\"$instance\"})/sum(node_memory_MemTotal_bytes{instance=~\"$instance\"})","refId":"A"}]},{"id":3,"type":"stat","title":"Disque utilisé %","gridPos":{"h":4,"w":3,"x":6,"y":0},"datasource":{"type":"prometheus","uid":"prometheus"},"options":{"graphMode":"none","colorMode":"value"},"fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1}},"targets":[{"expr":"1 - sum(node_filesystem_avail_bytes{instance=~\"$instance\", fstype=~\"ext4|xfs\"})/sum(node_filesystem_size_bytes{instance=~\"$instance\", fstype=~\"ext4|xfs\"})","refId":"A"}]},{"id":4,"type":"stat","title":"Temp °C","description":"Température CPU (hwmon). Si vide : activer hwmon ou script textfile /sys/class/thermal/thermal_zone0/temp","gridPos":{"h":4,"w":3,"x":9,"y":0},"datasource":{"type":"prometheus","uid":"prometheus"},"options":{"graphMode":"none","colorMode":"value"},"fieldConfig":{"defaults":{"unit":"celsius","min":0,"max":85},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":60},{"color":"red","value":75}]}},"targets":[{"expr":"avg(node_hwmon_temp_celsius{instance=~\"$instance\"}) or avg(node_thermal_zone_temp{instance=~\"$instance\"})","refId":"A"}]},{"id":5,"type":"stat","title":"Load 1m","description":"Charge système (moyenne 1 min)","gridPos":{"h":4,"w":3,"x":12,"y":0},"datasource":{"type":"prometheus","uid":"prometheus"},"options":{"graphMode":"none","colorMode":"value"},"targets":[{"expr":"avg(node_load1{instance=~\"$instance\"})","refId":"A"}]},{"id":6,"type":"timeseries","title":"CPU usage %","description":"Filtré par le nœud sélectionné ci-dessus.","gridPos":{"h":6,"w":12,"x":0,"y":4},"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1}},"options":{"legend":{"displayMode":"list","placement":"bottom"}},"targets":[{"expr":"1 - avg by (instance)(rate(node_cpu_seconds_total{mode=\"idle\", instance=~\"$instance\"}[5m]))","refId":"A","legendFormat":"{{instance}}"}]},{"id":7,"type":"timeseries","title":"Mémoire dispo %","description":"Filtré par le nœud sélectionné.","gridPos":{"h":6,"w":12,"x":12,"y":4},"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1}},"options":{"legend":{"displayMode":"list","placement":"bottom"}},"targets":[{"expr":"sum by (instance)(node_memory_MemAvailable_bytes{instance=~\"$instance\"})/sum by (instance)(node_memory_MemTotal_bytes{instance=~\"$instance\"})","refId":"A","legendFormat":"{{instance}}"}]},{"id":8,"type":"timeseries","title":"Disque utilisé %","description":"Filtré par le nœud sélectionné.","gridPos":{"h":6,"w":12,"x":0,"y":10},"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"unit":"percentunit","min":0,"max":1}},"options":{"legend":{"displayMode":"list","placement":"bottom"}},"targets":[{"expr":"1 - sum by (instance)(node_filesystem_avail_bytes{instance=~\"$instance\", fstype=~\"ext4|xfs\"})/sum by (instance)(node_filesystem_size_bytes{instance=~\"$instance\", fstype=~\"ext4|xfs\"})","refId":"A","legendFormat":"{{instance}}"}]},{"id":9,"type":"timeseries","title":"Temp °C","description":"Filtré par le nœud sélectionné.","gridPos":{"h":6,"w":12,"x":12,"y":10},"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{"unit":"celsius","min":0,"max":85},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":60},{"color":"red","value":75}]}},"options":{"legend":{"displayMode":"list","placement":"bottom"}},"targets":[{"expr":"node_hwmon_temp_celsius{instance=~\"$instance\"} or node_thermal_zone_temp{instance=~\"$instance\"}","refId":"A","legendFormat":"{{instance}}"}]},{"id":10,"type":"timeseries","title":"Load 1m","description":"Filtré par le nœud sélectionné.","gridPos":{"h":6,"w":24,"x":0,"y":16},"datasource":{"type":"prometheus","uid":"prometheus"},"fieldConfig":{"defaults":{}},"options":{"legend":{"displayMode":"list","placement":"bottom"}},"targets":[{"expr":"node_load1{instance=~\"$instance\"}","refId":"A","legendFormat":"{{instance}}"}]}]}
